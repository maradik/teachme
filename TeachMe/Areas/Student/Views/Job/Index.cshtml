@using TeachMe.Extensions
@using TeachMe.Models.Jobs
@model IEnumerable<Job>

@{
    ViewBag.Title = "Задачи";
}

<h2>Мои задачи</h2>

<p>
    @Html.ActionLink("Создать новую", "Create")
</p>

@using (Html.BeginForm("DoJobAction", null, FormMethod.Post))
{
    @Html.AntiForgeryToken()
    @Html.Hidden("jobId")
    @Html.Hidden("jobActionType")
    @Html.Hidden("redirectActionName")
    <table class="table">
        <tr>
            <th>
                @Html.DisplayNameFor(model => model.SubjectId)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Title)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.StudentCost)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Status)
            </th>
            <th></th>
        </tr>

    @{
        var successJobStatuses = new[] { JobStatus.Finished, JobStatus.Accepted };
    }
    @foreach (var item in Model)
    {
        <tr>
            <td>
                <span class="label label-primary">@Html.DisplayFor(modelItem => item.GetSubject().Title)</span>
            </td>
            <td>
                @Html.ActionLink(item.Title, "Details", new { id = item.Id })
            </td>
            <td>
                <span class="label label-danger">@Html.DisplayFor(modelItem => item.StudentCost) руб.</span>
            </td>
            <td>
                <span class="label @(successJobStatuses.Contains(item.Status) ? "label-success" : "label-warning")">@item.Status.GetHumanAnnotation()</span>
            </td>
            <td>
                <div class="dropdown">
                    <button class="btn btn-default btn-sm dropdown-toggle" type="button" id="@("actionDropdownMenu" + item.Id)" data-jobid="@item.Id" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                        Действие
                        <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="@("actionDropdownMenu" + item.Id)">
                    </ul>
                </div>
            </td>
        </tr>
    }
    </table>
    }
<script>
    $(function() {
        $("button[id^='actionDropdownMenu']").click(function () {
            var dropDownButton = $(this);
            var attributeOfLoaded = "data-actionsloaded";
            if (!dropDownButton.attr(attributeOfLoaded)) {
                var actionsContainer = dropDownButton.parent("div").find("ul");
                var actionElement = $("<li><a href='#'>Загрузка...</a></li>");
                actionsContainer.append(actionElement);
                var jobId = dropDownButton.attr("data-jobid");
                $.ajax(
                    "/Student/Job/_GetAvailableActions?jobId=" + jobId,
                    {
                        type: "GET",
                        contentType: "application/json; charset=utf-8",
                        data: "{}",
                        dataType: "json",
                        success: function (jobActions) {
                            actionsContainer.html("");
                            if (jobActions.length != 0) {
                                jobActions.forEach(function (jobAction) {
                                    var actionElement = $("<a href='#' />");
                                    actionElement.text(jobAction.Text);
                                    actionElement.attr("data-jobactiontype", jobAction.Value);
                                    actionElement.attr("data-jobid", jobId);
                                    actionElement.attr("data-redirectactionname", "Index");
                                    if (jobAction.Value == 10 /*delete*/) {
                                        actionElement.attr("data-jobactionconfirmation", 'Удалить задачу?');
                                    }
                                    actionElement.click(function () {
                                        doJobAction(this);
                                    });
                                    var actionElementLi = $("<li/>");
                                    actionElementLi.html(actionElement);
                                    actionsContainer.append(actionElementLi);
                                });
                            }
                            else {
                                var dummyActionElement = $("<li><a href='#'>Нет действий</a></li>");
                                dummyActionElement.click(function () { return false; });
                                actionsContainer.html(dummyActionElement);
                            }
                        }
                    }
                );
                dropDownButton.attr(attributeOfLoaded, "true");
            }
            return true;
        });


    });
</script>
